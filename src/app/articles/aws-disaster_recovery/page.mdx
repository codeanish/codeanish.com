import {ArticleLayout} from '@/components/ArticleLayout'
import Image from 'next/image'
// import apigateway1 from './APIGatewayImage1.png'
// import apigateway2 from './APIGatewayImage2.png'

export const dynamic = 'force-static';

export const article = {
    author: 'Anish Patel',
    date: '2024-01-24',
    title: 'Disaster Recovery Considerations in AWS',
    description: 'When you use the cloud for deploying your applications, do not assume that it\s different to anything else you\'ve deployed in a data center, you still need to think about disaster recovery.',
}

export const metdata = {
    title: article.title,
    description: article.description,
}

export default (props) => <ArticleLayout article={article} {...props}/>

Years ago, I worked at an Investment Bank, boy did they take disaster recovery seriously.
One could be forgiven for thinking that their business depended on it. We had our applications
and data deployed in one data center, and a mirror of the applications and data in another, 
geographically separate data center. Every 6 months, we had to take it in turns to be the BCP guy
for the weekend and go down to the second data center and failover our services to the secondary site.
This kind of business practice may seem archaic these days, but when it comes to running critical
systems, you need to have a great deal of confidence in being able to continue operating your business
even when things go wrong - which they eventually always do.

**All businesses running business critical applications need to pay attention to their BCP (Business Continuity Plan)**

## What is the difference between BCP and Disaster Recover Plans?

A Business Continuity Plan (BCP) is a plan you develop with your business to determine
how in the event of a disaster, you're going to keep your business-critical operations going.
Let's imagine we own a coffee shop and our electronic payment system is out of action, this would
be absolutely dreadful for the coffee shop if they're unable to accept payments for coffee. A BCP
plan for the coffee shop might include things like - have some petty cash on hand to be
able to accept payments, directing customers to the nearest ATM to get cash, keeping a paper ledger in
place so that transactions can be recorded etc. The plan would include detailed instructions
for the staff to ensure that they're able to keep the functions of the coffee shop working as 
smoothly as possible.

A Disaster Recovery plan has a slightly different focus to a BCP plan. It's less focussed on
ensuring that the business operations can continue to function in the event of a catastrophe, but
rather on building out IT infrastructure to meet some key IT objectives to minimise data loss and
to return their systems to a working state as soon as possible. These two metrics are known as 
Recovery Point Objective (RPO) and Recovery Time Objective (RTO).

## RTO and RPO

RPO is measured as the period of time before a disaster strikes to the last known good state of
the application. Lets take our coffee shop payment system as an example again. If our payment 
processing capability stops at some point, there was a point before that when it was working.
While it's working, transactions are being written to your data store

There are a few headers that you can set on a preflight request. The most common ones are:

- `Access-Control-Allow-Origin`: This header tells the browser which domains are allowed to access
your API. If you set this to `*`, then any domain can access your API. If you set it to a specific
domain, then only that domain can access your API. You can also set it to a list of domains.
- `Access-Control-Allow-Methods`: This header tells the browser which HTTP methods are allowed
for your API. This is a comma separated list of methods allowed, e.g. GET, PUT, POST, DELETE. It can also
be set to `*` which will allow all methods.
- `Access-Control-Allow-Headers`: This header tells the browser which headers are allowed
for your API. Here you can set a comma separated list of headers that are allowed. For our case
we'll need to set `Content-Type`. It can also be set to `*` which will allow all headers.
- `Access-Control-Allow-Credentials`: This header tells the browser whether or not it should
send cookies with the request. This header is optional, but if you want to use cookies with your
API, then you'll need to set it.
- `Access-Control-Max-Age`: This header tells the browser how long it should cache the preflight
response for. This header is optional, but if you want to use cookies with your API, then you'll
need to set it. Even though this is optional, it's a good idea to set it to a reasonable value, I 
usually set it to 10 minutes. This will prevent the browser from sending a preflight request every
time you make a request to your API and should improve performance.

## How do I enable CORS in API Gateway?

Looking at the API Gateway console, you'll see that I've already set up a route which I want 
to set up CORS for. Assuming AWS doesn't change it again, you'll see in the left hand pane under
Develop, a section called CORS. Click on that and you'll see a bunch of options.

{/* <Image src={apigateway1} alt=""/> */}

The CORS section of the API Gateway console provides you with the ability to set your various
CORS headers. I want to lock down my particular API to only allow requests from my domain, so
I'll set the `Access-Control-Allow-Origin` header to `https://codeanish.com`. For this API, I am
only using it for email list signups so I only need to allow POST requests, so I'll set the 
`Access-Control-Allow-Methods` header to `POST`. I also need to allow the `Content-Type` header
so I'll set the `Access-Control-Allow-Headers` header to `Content-Type`. I'm not using cookies
for this API so I'll leave the `Access-Control-Allow-Credentials` header set to `NO`. Finally, I'll set
the `Access-Control-Max-Age` header to `600` seconds.

{/* <Image src={apigateway2} alt=""/> */}

Once you've set all of your headers, click the Deploy button at the top of the page. This will
deploy your API with the new CORS settings. You should now be able to make requests to your API
from your browser.

I can't tell you how many times I've been developing an API and I've forgotten to set up CORS.
Hopefully you can see that it's not super complicated to set up on API Gateway. If you happen to
be hosting your API using something else e.g. Express/FastAPI/Flask, then you'll need to set up
CORS there. 